<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coorde.myapp.mapper.ClosetMapper">

	<select id="getClosetList" parameterType="String" resultType="com.coorde.myapp.entity.Closet">
	    SELECT * FROM closet_tb where cl_cate = #{cl_cate} ORDER BY RAND()
	    
	</select>
	
	<select id="getAllCloset" resultType="com.coorde.myapp.entity.Closet">
	    SELECT * FROM closet_tb ORDER BY RAND()
	</select>
	
	<delete id="deleteCloset" parameterType="list">
	    DELETE FROM closet_tb WHERE cl_idx IN
	    <foreach collection="list" item="closetidx" open="(" separator="," close=")">
	        #{closetIdx}
	    </foreach>
	</delete>
	
	<delete id="deleteClosetAndSize" parameterType="list">
    DELETE c, s
    FROM closet_tb c
    LEFT JOIN cl_size_tb s ON c.cl_idx = s.cl_idx
    WHERE c.cl_idx IN
    <foreach collection="list" item="closetIdx" open="(" separator="," close=")">
        #{closetIdx}
    </foreach>
	</delete>
	
	<select id="getTopColors" parameterType="string" resultType="string">
	    SELECT cl_color
	    FROM wish_tb
	    JOIN closet_tb ON wish_tb.cl_idx = closet_tb.cl_idx
	    WHERE user_id = #{user_id}
	    GROUP BY cl_color
	    ORDER BY COUNT(*) DESC
	    LIMIT 3;
	</select>
	
	<select id="getTopCategories" parameterType="string" resultType="string">
	    SELECT cl_cate_detail
	    FROM wish_tb
	    JOIN closet_tb ON wish_tb.cl_idx = closet_tb.cl_idx
	    WHERE user_id = #{user_id}
	    GROUP BY cl_cate_detail
	    ORDER BY COUNT(*) DESC
	    LIMIT 3;
	</select>
	
	<select id="getFilteredClothes" parameterType="map" resultType="com.coorde.myapp.entity.Closet">
	    SELECT * FROM closet_tb
	    WHERE cl_color IN
	    <foreach item="color" collection="topColors" open="(" separator="," close=")">
	        #{color}
	    </foreach>
	    AND cl_cate_detail IN
	    <foreach item="category" collection="topCategories" open="(" separator="," close=")">
	        #{category}
	    </foreach>
	    order by rand()
	</select>
	
	<select id="checkWish" parameterType="map" resultType="int">
		select count(*) 	
		from wish_tb 
		where user_id = #{user_id} and cl_idx = #{cl_idx}
	</select>
	
	<insert id="insertToWish" parameterType="map">
		insert into wish_tb(cl_idx, user_id)
		values(#{cl_idx}, #{user_id})
	</insert>
	
	<delete id="deleteToWish" parameterType="map">
		delete from wish_tb
		where user_id = #{user_id} and cl_idx = #{cl_idx}
	</delete>

</mapper>